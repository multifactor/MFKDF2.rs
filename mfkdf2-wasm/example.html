<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>MFKDF2 WASM Example</title>
</head>

<body>
    <h1>MFKDF2 WASM Example</h1>
    <div id="output"></div>

    <script type="module">
        import init, {
            setup_key,
            setup_password_factor,
            derive_key_with_password,
            MFKDFOptions,
            set_panic_hook,
            console_log
        } from './pkg/mfkdf2_wasm.js';

        async function run() {
            // Initialize the wasm module
            await init();
            set_panic_hook();

            const output = document.getElementById('output');

            try {
                output.innerHTML += '<h2>Setting up MFKDF2 Key</h2>';

                // Create a password factor
                console_log("Creating password factor...");
                const passwordFactor = setup_password_factor("mypassword123", "password");
                output.innerHTML += `<p>Password factor created with ID: ${passwordFactor.id}</p>`;
                output.innerHTML += `<p>Factor type: ${passwordFactor.type}</p>`;
                output.innerHTML += `<p>Entropy: ${passwordFactor.entropy} bits</p>`;

                // Create options
                const options = new MFKDFOptions();
                options.set_threshold(1);
                options.set_id("test-key-123");

                // Setup the key
                console_log("Setting up key...");
                const setupKey = await setup_key([passwordFactor], options);

                output.innerHTML += '<h2>Setup Complete</h2>';
                output.innerHTML += `<p>Key: ${Array.from(setupKey.key).map(b => b.toString(16).padStart(2, '0')).join('')}</p>`;
                output.innerHTML += `<p>Secret: ${Array.from(setupKey.secret).map(b => b.toString(16).padStart(2, '0')).join('')}</p>`;

                // Get the policy
                const policyJson = setupKey.policy;
                output.innerHTML += '<h2>Policy</h2>';
                output.innerHTML += `<pre>${JSON.stringify(JSON.parse(policyJson), null, 2)}</pre>`;

                // Test key derivation
                output.innerHTML += '<h2>Key Derivation</h2>';
                console_log("Deriving key...");
                const derivedKey = await derive_key_with_password(policyJson, "mypassword123", "password");

                output.innerHTML += `<p>Derived Key: ${Array.from(derivedKey.key).map(b => b.toString(16).padStart(2, '0')).join('')}</p>`;
                output.innerHTML += `<p>Derived Secret: ${Array.from(derivedKey.secret).map(b => b.toString(16).padStart(2, '0')).join('')}</p>`;

                // Verify they match
                const setupKeyHex = Array.from(setupKey.key).map(b => b.toString(16).padStart(2, '0')).join('');
                const derivedKeyHex = Array.from(derivedKey.key).map(b => b.toString(16).padStart(2, '0')).join('');

                if (setupKeyHex === derivedKeyHex) {
                    output.innerHTML += '<p style="color: green;"><strong>✅ SUCCESS: Keys match!</strong></p>';
                } else {
                    output.innerHTML += '<p style="color: red;"><strong>❌ ERROR: Keys do not match!</strong></p>';
                }

            } catch (error) {
                output.innerHTML += `<p style="color: red;"><strong>Error: ${error}</strong></p>`;
                console.error('Error:', error);
            }
        }

        run();
    </script>
</body>

</html>